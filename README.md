# Shared Password Hasher Library

A Go library providing Argon2id password hashing compatible across all BengoBox services. This library ensures password hashes generated by any service can be verified by any other service, including the centralized auth-service.

**Repository:** `github.com/Bengo-Hub/shared-password-hasher`

## Features

- ✅ **Argon2id Algorithm**: Industry-standard memory-hard hashing
- ✅ **Cross-Service Compatibility**: Works with auth-service and all BengoBox services
- ✅ **PHC String Format**: Standard format for password hashes
- ✅ **Configurable Parameters**: Adjust memory, time, and parallelism
- ✅ **Constant-Time Comparison**: Protection against timing attacks
- ✅ **Zero Dependencies**: Only `golang.org/x/crypto` required

## Installation

### Production (Recommended)

```bash
go get github.com/Bengo-Hub/shared-password-hasher@latest
```

```go
require (
    github.com/Bengo-Hub/shared-password-hasher v0.1.0
)
```

### Local Development

Clone into your BengoBox workspace and use `go.work`:

```bash
cd BengoBox/shared/
git clone https://github.com/Bengo-Hub/shared-password-hasher.git password-hasher

# Add to go.work at BengoBox root
go work use ./shared/password-hasher
```

## Usage

### Basic Usage

```go
import (
    passwordhasher "github.com/Bengo-Hub/shared-password-hasher"
)

// Create hasher with default parameters (matches auth-service)
hasher := passwordhasher.NewHasher()

// Hash a password
hash, err := hasher.Hash("ChangeMe123!")
if err != nil {
    log.Fatal(err)
}
// Output: $argon2id$v=19$m=65536,t=3,p=2$<base64-salt>$<base64-hash>

// Verify a password
err = hasher.Verify("ChangeMe123!", hash)
if err == passwordhasher.ErrPasswordMismatch {
    log.Println("Invalid password")
} else if err != nil {
    log.Fatal(err)
} else {
    log.Println("Password verified!")
}
```

### Custom Parameters

```go
// Create hasher with custom Argon2id parameters
// Parameters: memorySize (KB), iterations, parallelism, keyLength
hasher := passwordhasher.NewCustomHasher(
    32768,  // 32 MiB memory
    4,      // 4 iterations
    4,      // 4 threads
    32,     // 32-byte output
)

hash, _ := hasher.Hash("SecurePassword")
```

### User Registration Example

```go
func RegisterUser(email, password string) error {
    hasher := passwordhasher.NewHasher()
    
    // Hash password before storing
    passwordHash, err := hasher.Hash(password)
    if err != nil {
        return fmt.Errorf("hash password: %w", err)
    }
    
    // Store user with hashed password
    user := User{
        Email:        email,
        PasswordHash: passwordHash,
    }
    
    return db.Create(&user)
}
```

### User Login Example

```go
func LoginUser(email, password string) (*User, error) {
    hasher := passwordhasher.NewHasher()
    
    // Fetch user from database
    user, err := db.GetUserByEmail(email)
    if err != nil {
        return nil, err
    }
    
    // Verify password
    err = hasher.Verify(password, user.PasswordHash)
    if err == passwordhasher.ErrPasswordMismatch {
        return nil, errors.New("invalid credentials")
    } else if err != nil {
        return nil, fmt.Errorf("verify password: %w", err)
    }
    
    return user, nil
}
```

## Default Parameters

The library uses the following default Argon2id parameters, matching auth-service configuration:

```go
const (
    DefaultMemorySize   = 65536  // 64 MiB in KB
    DefaultIterations   = 3      // Time cost
    DefaultParallelism  = 2      // Number of threads
    DefaultKeyLength    = 32     // 32-byte output hash
    DefaultSaltLength   = 16     // 16-byte random salt
)
```

These parameters provide a good balance between security and performance for most use cases.

## Hash Format

Hashes follow the PHC string format:

```
$argon2id$v=19$m=65536,t=3,p=2$<base64-salt>$<base64-hash>
```

Where:
- `argon2id`: Algorithm identifier
- `v=19`: Argon2 version 1.3
- `m=65536`: Memory size in KB (64 MiB)
- `t=3`: Number of iterations
- `p=2`: Degree of parallelism
- `<base64-salt>`: Base64-encoded salt (no padding)
- `<base64-hash>`: Base64-encoded hash (no padding)

## Cross-Service Usage

### In Auth Service

```go
// auth-service uses this library for all password operations
import passwordhasher "github.com/Bengo-Hub/shared-password-hasher"

func (s *AuthService) RegisterUser(req *RegisterRequest) error {
    hasher := passwordhasher.NewHasher()
    hash, err := hasher.Hash(req.Password)
    if err != nil {
        return err
    }
    
    // Store user in auth-service database
    return s.CreateUser(req.Email, hash, req.TenantSlug)
}
```

### In TruLoad Backend (.NET)

For .NET services like TruLoad, use the equivalent .NET implementation:

```csharp
// Create matching .NET implementation in TruLoad backend
using BengoBox.Shared.Infrastructure.Security;

var hasher = new PasswordHasher();
var hash = hasher.HashPassword("ChangeMe123!");

// Verify password (works with hashes from Go services)
bool isValid = hasher.VerifyPassword("ChangeMe123!", hash);
```

### In Other Go Services

```go
// Any other Go service (ordering, notifications, etc.)
import passwordhasher "github.com/Bengo-Hub/shared-password-hasher"

func SyncUserToAuthService(user *User, password string) error {
    hasher := passwordhasher.NewHasher()
    hash, _ := hasher.Hash(password)
    
    // Send to auth-service with pre-hashed password
    return authClient.CreateUser(user.ID, user.Email, hash)
}
```

## Testing

```bash
# Run tests
go test -v

# Run benchmarks
go test -bench=. -benchmem

# Test coverage
go test -cover -coverprofile=coverage.out
go tool cover -html=coverage.out
```

Example benchmark results:
```
BenchmarkHash-8       100   15,234,567 ns/op   42,123 B/op   23 allocs/op
BenchmarkVerify-8     100   15,567,890 ns/op   42,456 B/op   24 allocs/op
```

## Security Considerations

1. **Never store plaintext passwords**: Always hash before storing
2. **Use strong passwords**: Enforce minimum length and complexity
3. **Don't log passwords**: Never log plaintext or hashed passwords
4. **Random salts**: Library generates cryptographically random salts
5. **Constant-time comparison**: Prevents timing attacks during verification

## Versioning and Tagging

Follow semantic versioning:

```bash
# Tag a new version
git tag v0.1.0
git push origin v0.1.0

# Update in services
go get github.com/Bengo-Hub/shared-password-hasher@v0.1.0
```

See [TAGGING.md](./TAGGING.md) for detailed versioning guide.

## Integration with Auth Service

This library is designed to be 100% compatible with the auth-service password implementation. Any hash generated by this library can be verified by auth-service and vice versa.

### Migration from Existing Systems

If migrating from a different hashing algorithm:

1. Update new user passwords to use this library
2. Keep old hashing logic for existing users
3. On successful login, rehash with new algorithm
4. Gradually migrate all users to Argon2id

## Contributing

1. Fork the repository
2. Create a feature branch
3. Add tests for new functionality
4. Ensure all tests pass
5. Submit a pull request

## License

MIT License - See LICENSE file for details

## Support

For issues or questions:
- GitHub Issues: https://github.com/Bengo-Hub/shared-password-hasher/issues
- Documentation: https://github.com/Bengo-Hub/shared-password-hasher/wiki
